<CONTENT VERSION="1.0" LANG="fr" CHARSET="utf-8"/>

/**
 * Main article.
 */
<DEFMACRO NAME="CKL_A_MAIN">
  <LOOP NAME="ckl_a_main"
        TABLE="textes"
        WHERE="id=[#DOCUMENT]">
    <DO>
      <div class="ckl-main ckl-article">
        <MACRO NAME="CKL_A_NAV"/>
        <div class="ckl-content">
          <MACRO NAME="CKL_A_CONTENT"/>
        </div>
      </div>
    </DO>
    <ALTERNATIVE>
      <p>Article [#DOCUMENT] not found.</p>
    </ALTERNATIVE>
  </LOOP>
</DEFMACRO>

/**
 * Barre superieure article.
 */
<DEFMACRO NAME="CKL_A_NAV">
  <nav class="ckl-nav">
    <ul class="ckl-nav-list">
      <li class="ckl-nav-item"><a href="[#ID|makeurlwithid]">&#x1f441; Voir en ligne</a></li>
      <li class="ckl-nav-item"><a href="./lodel/edition/index.php?do=view&id=[#ID]">&#x270E; Éditer</a></li>
    </ul>
  </nav>
</DEFMACRO>

/**
 * Contenu article.
 */
<DEFMACRO NAME="CKL_A_CONTENT">
  <!--[ Section Titre ]-->
  <section class="ckl-section">
    <!--[ Titre du document ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="titre" VALUE="[#TITRE]"/>

    <!--[ Sous-titre du document ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="soustitre" VALUE="[#SOUSTITRE]"/>
  </section>


  <!--[ Section Cartouche ]-->
  <section class="ckl-cartouche">
    <!--[ Date de la publication électronique ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="datepubli" VALUE="[#DATEPUBLI]"/>

    <!--[ Date de la publication papier ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="datepublipapier" VALUE="[#DATEPUBLIPAPIER]"/>

    <!-- [ Barrière mobile ] -->
    <LET VAR="BM">0</LET>
    <IF COND="[#TYPE] EQ 'article' AND [#DATEPUBLI] GT today()">
      <LET VAR="BM">1</LET>
    </IF>
    <FUNC NAME="CKL_FIELD_BOOL" FIELD="Barrière mobile" VALUE="[#BM]" OUI="Cet article est sous barrière mobile." NON="Cet article est en libre accès."/>

    <!--[ Langue ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="langue" VALUE="[#LANGUE]"/>

    <!--[ Date de mise en ligne ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="datemisenligne" VALUE="[#DATEMISENLIGNE]"/>

    <!--[ Date de mise en accès libre ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="dateacceslibre" VALUE="[#DATEACCESLIBRE]"/>

    <!-- [ Vignettisation simple ] -->
    <FUNC NAME="CKL_FIELD_BOOL" FIELD="vignettesimple" VALUE="[#VIGNETTESIMPLE]" OUI="Activé" NON="Désactivé"/>
  </section>

  <!-- [ Section Personnes ] -->
  <section class="ckl-section">
    <!--[ Auteurs ]-->
    <FUNC NAME="CKL_A_DESCRIPTION_PERSONNES" TYPE="auteur" IDDOC="[#ID]"/>

    <!--[ Traducteurs ]-->
    <FUNC NAME="CKL_A_DESCRIPTION_PERSONNES" TYPE="traducteur" IDDOC="[#ID]"/>

    <!--[ Editeurs scientifiques ]-->
    <FUNC NAME="CKL_A_DESCRIPTION_PERSONNES" TYPE="editeurscientifique" IDDOC="[#ID]"/>
  </section>

  <!-- [ Section Métadonnées ] -->
  <section class="ckl-section">
    <!--[ Numéro de document ]-->
    <IF COND="[#NUMERODOCUMENT] AND [#NUMERODOCUMENT] NE '0'">
      <FUNC NAME="CKL_FIELD_STRING" FIELD="numerodocument" VALUE="[#NUMERODOCUMENT]"/>
    </IF>

    <!--[ Titres alternatifs ]-->
    <FUNC NAME="CKL_FIELD_ML" FIELD="altertitre" VALUE="[#ALTERTITRE]"/>

    <!--[ Alias de traduction ]-->
    <MACRO NAME="CKL_TRADUCTIONS"/>

    <!-- [ Résumés ] -->
    <FUNC NAME="CKL_FIELD_ML" FIELD="resume" VALUE="[#RESUME]"/>

    <!-- [ Entrées d'index ] -->
    <FUNC NAME="CKL_ENTRIES" CLASSNAME="indexes"/>

    <!--[ Pagination ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="pagination" VALUE="[#PAGINATION]"/>
  </section>

  <!-- [ Section Œuvre commentée ] -->
  <section class="ckl-section">
    <!--[ Notice bibliographique de l’œuvre commentée ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="noticebibliooeuvre" VALUE="[#NOTICEBIBLIOOEUVRE]"/>

    <!--[ Titre de l’œuvre commentée ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="titreoeuvre" VALUE="[#TITREOEUVRE]"/>

    <!--[ Date de publication de l’œuvre commentée ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="datepublicationoeuvre" VALUE="[#DATEPUBLICATIONOEUVRE]"/>

    <!--[ Auteur de l’œuvre commentée ]-->
    <FUNC NAME="CKL_PERSONNES" TYPE="auteuroeuvre"/>
  </section>

  <!--[ Section Fichiers ]-->
  <section class="ckl-section">
    <!--[ Fichier facsimilé ]-->
    <MACRO NAME="CKL_A_FACSIMILE"/>

    <!--[ Fichiers ]-->
    <MACRO NAME="CKL_A_FICHIERS"/>

    <!--[ Fichiers externes ]-->
    <MACRO NAME="CKL_A_FICHIERSEXTERNES"/>
  </section>

  <!--[ Section Paratexte ]-->
  <section class="ckl-section">
    <!--[ NDLR ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="ndlr" VALUE="[#NDLR]"/>

    <!--[ NDLA ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="ndla" VALUE="[#NDLA]"/>

    <!--[ Errata ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="addendum" VALUE="[#ADDENDUM]"/>

    <!--[ Dédicace ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="dedicace" VALUE="[#DEDICACE]"/>

    <!--[ Remerciements ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="remerciements" VALUE="[#REMERCIEMENTS]"/>
  </section>

  <!--[ Section Texte ]-->
  <section class="ckl-section">
    <!-- [ Sommaire de l'article ] -->
    <MACRO NAME="CKL_A_TOC"/>

    <!--[ Texte intégral ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="texte" VALUE="[#TEXTE|cleanCallNotes|tocable|tocss('heading')|illustrations(300)|media]" CLASSNAME="ckl-field-text" />
  </section>

  <!--[ Section Bibliographie ]-->
  <section class="ckl-section">
    <!--[ Bibliographie ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="bibliographie" VALUE="[(#BIBLIOGRAPHIE|cleanCallNotes|tocss('heading')|illustrations(300, 'bibliographie')|media)]" CLASSNAME="ckl-field-text" />
  </section>

  <!--[ Section Annexes ]-->
  <section class="ckl-section">
    <!--[ Annexes (texte) ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="annexe" VALUE="[#ANNEXE|cleanCallNotes|tocss('heading')|illustrations(300, 'annexe')|media]" CLASSNAME="ckl-field-text" />
  </section>

  <!--[ Section Notes ]-->
  <section class="ckl-section">
    <!--[ Notes de bas de page ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="notesbaspage" VALUE="[#NOTESBASPAGE]" CLASSNAME="ckl-field-text"/>

    <!--[ Notes de fin ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="notefin" VALUE="[#NOTEFIN]"/>
  </section>
</DEFMACRO>

/**
 * Table des matières de l'article.
 */
<DEFMACRO NAME="CKL_A_TOC">
  <IF COND="[#TEXTE]">
    <div class="ckl-field">
      <div class="ckl-field-title">[@TOC]</div>
      <div class="ckl-field-value">
        <LET VAR="TOC_PREV_NIVEAU" GLOBAL="1">1</LET>
        <LET VAR="OUVRIR_UL"><ul></LET>
        <LET VAR="FERMER_UL"></ul></li></LET>
        <!--[ [#COUNT] et <DOFIRST> ne fonctionnent pas pour la loop "toc" donc on utilise un workaround avec une variable globale [%TOC_COUNT] ]-->
        <LET VAR="TOC_COUNT" GLOBAL="1">0</LET>
        <LOOP NAME="toc" TEXT="[#TEXTE]">
          <BEFORE>
            <div class="ckl-toc">
              <ul>
          </BEFORE>
          <DO>
            <LET VAR="TOC_COUNT" GLOBAL="1">[%TOC_COUNT|lmath('+', '1')]</LET>
            <LET VAR="ECART">[#NIVEAU|lmath('-', [%TOC_PREV_NIVEAU])]</LET>
            <LET VAR="LIEN"><a href="#tocto[#TOCID]" id="tocfrom[#TOCID]">[#TITRE|removenotes]</a></LET>
            <IF COND="[#ECART] EQ 0">
              <IF COND="[%TOC_COUNT] GT 1"></li></IF>
              <li dir="[#DIR]">[#LIEN]
            <ELSEIF COND="[#ECART] GT 0"/>
              [#OUVRIR_UL|str_repeat([#ECART])]
              <li dir="[#DIR]">[#LIEN]
            <ELSE/>
              <IF COND="[%TOC_COUNT] GT 1"></li></IF>
              [#FERMER_UL|str_repeat([#ECART|lmath('*', -1)])]
              <li dir="[#DIR]">[#LIEN]
            </IF>
            <LET VAR="TOC_PREV_NIVEAU" GLOBAL="1">[#NIVEAU]</LET>
          </DO>
          <AFTER>
                <!--[ Fermeture des derniers ul/li ]-->
                </li>
                <IF COND="[%TOC_PREV_NIVEAU] GT 1">
                  [#FERMER_UL|str_repeat([%TOC_PREV_NIVEAU|lmath('-', 1)])]
                </IF>
              </ul>
            </div>
          </AFTER>
        </LOOP>
      </div>
    </div>
  </IF>
</DEFMACRO>

/**
 * Fac-similé.
 */
<DEFMACRO NAME="CKL_A_FACSIMILE">
  <IF COND="[#ALTERFICHIER]">
    <div class="ckl-field ckl-facsimile">
      <div class="ckl-field-title"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="alterfichier"/></div>
      <div class="ckl-field-value"><a class="ckl-facsimile-a" href="[#ID|makeurlwithid]?file=1"><span class="ckl-facsimile-mime">[#ALTERFICHIER|getFileMime]</span>&#160;&#8211; <span class="ckl-facsimile-size">[#ALTERFICHIER|nicefilesize]</span></a></div>
    </div>
  </IF>
</DEFMACRO>

/**
 * Description des auteurs, traducteurs...
 * @param {string} type - Type de personne.
 * @param {string} type - ID du document auquel est liée la description.
 */
<DEFFUNC NAME="CKL_A_DESCRIPTION_PERSONNES" REQUIRED="type, iddoc">
  <LOOP NAME="ckl_a_description_personnes" SELECT="persons.id" TABLE="relations, persons" WHERE="id1 = '[#IDDOC]' AND id2 = persons.id AND nature = 'G' AND type = '[#TYPE]'" ORDER="degree">
    <BEFORE>
      <div class="ckl-field ckl-description-personnes" data-type="[#TYPE]">
        <div class="ckl-field-title"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="[#TYPE]"/></div>
        <div class="ckl-field-value">
    </BEFORE>
    <DO>
      <LOOP NAME="ckl_a_description_personnes_item" TABLE="auteurs" WHERE="id = '[#ID]' AND iddocument='[#IDDOC]'">
        <div class="ckl-personne" data-type="[#TYPE]" data-id="[#ID]">
          <LET VAR="label_prenom"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="prenom"/></LET>
          <LET VAR="label_nom"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="nomfamille"/></LET>
          <span class="ckl-personne-firstname" data-label="[#LABEL_PRENOM|trim]">[#G_FIRSTNAME]</span>
          <span class="ckl-personne-familyname" data-label="[#LABEL_NOM|trim]">[#G_FAMILYNAME]</span>
          <IF COND="[#DESCRIPTION]">
            <!--[ TODO: label dynamique ]-->
            <p class="ckl-personne-description" data-label="Description">[#DESCRIPTION|removetags("p")]</p>
          </IF>
        </div>
      </LOOP>
    </DO>
    <AFTER>
        </div>
      </div>
    </AFTER>
  </LOOP>
</DEFFUNC>

/**
 * Fichiers.
 */
<DEFMACRO NAME="CKL_A_FICHIERS">
  <LOOP NAME="ckl_a_fichiers"
        TABLE="fichiers"
        WHERE="idparent = [#ID]"
        SELECT="id, titre, type, document"
        ORDER="rank">
    <BEFORE>
      <div class="ckl-field ckl-fichiers">
        <div class="ckl-field-title">Fichiers</div>
        <div class="ckl-field-value">
    </BEFORE>
    <DO>
      <div class="ckl-fichier">
        <LET VAR="label_titre"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="titre"/></LET>
        <p class="ckl-fichier-titre" data-label="[#LABEL_TITRE|trim]"><IF COND="[#TITRE]">[#TITRE]<ELSE/>-</IF></p>
        <!--[ TODO: Label dynamique ]-->
        <p class="ckl-fichier-type" data-label="Type">[#TYPE]</p>
        <IF COND="[#DOCUMENT]">
          <LET VAR="label_document"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="document"/></LET>
          <p class="ckl-fichier-document" data-label="[#LABEL_DOCUMENT|trim]"><a href="[#DOCUMENT]">[#DOCUMENT]</a></p>
        </IF>
      </div>
    </DO>
    <AFTER>
        </div>
      </div>
    </AFTER>
  </LOOP>
</DEFMACRO>

/**
 * Fichiers externes.
 */
<DEFMACRO NAME="CKL_A_FICHIERSEXTERNES">
  <LOOP NAME="ckl_a_fichiersexternes"
        TABLE="fichiersexternes"
        WHERE="idparent = [#ID]"
        SELECT="id, titre, type, urlmedia"
        ORDER="rank">
    <BEFORE>
      <div class="ckl-field ckl-fichiersexternes">
        <div class="ckl-field-title">Fichiers externes</div>
        <div class="ckl-field-value">
    </BEFORE>
    <DO>
      <div class="ckl-fichierexterne">
        <LET VAR="label_titre"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="titre"/></LET>
        <p class="ckl-fichierexterne-titre" data-label="[#LABEL_TITRE|trim]"><IF COND="[#TITRE]">[#TITRE]<ELSE/>-</IF></p>
        <!--[ TODO: Label dynamique ]-->
        <p class="ckl-fichierexterne-type" data-label="Type">[#TYPE]</p>
        <IF COND="[#URLMEDIA]">
          <LET VAR="label_urlmedia"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="urlmedia"/></LET>
          <p class="ckl-fichierexterne-urlmedia" data-label="[#LABEL_URLMEDIA]"><a href="[#URLMEDIA]">[#URLMEDIA]</a></p>
        </IF>
      </div>
    </DO>
    <AFTER>
        </div>
      </div>
    </AFTER>
  </LOOP>
</DEFMACRO>
