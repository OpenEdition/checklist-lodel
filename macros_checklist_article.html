<CONTENT VERSION="1.0" LANG="fr" CHARSET="utf-8"/>

/**
 * Main article.
 */
<DEFMACRO NAME="CKL_A_MAIN">
  <LOOP NAME="ckl_a_main"
        TABLE="textes"
        WHERE="id=[#ID_ARTICLE]">
    <DO>
      <MACRO NAME="CKL_A_CONTENT"/>
    </DO>
    <ALTERNATIVE>
      <p>Article [#ID_ARTICLE] not found.</p>
    </ALTERNATIVE>
  </LOOP>
</DEFMACRO>

/**
 * Contenu article.
 */
<DEFMACRO NAME="CKL_A_CONTENT">
  <!--[ Numéro de document ]-->
  <IF COND="[#NUMERODOCUMENT] AND [#NUMERODOCUMENT] NE '0'">
    <FUNC NAME="CKL_FIELD_STRING" FIELD="numerodocument" VALUE="[#NUMERODOCUMENT]"/>
  </IF>

  <!--[ Titre du document ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="titre" VALUE="[#TITRE]"/>

  <!--[ Sous-titre du document ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="soustitre" VALUE="[#SOUSTITRE]"/>

  <!--[ Titres alternatifs ]-->
  <FUNC NAME="CKL_FIELD_ML" FIELD="altertitre" VALUE="[#ALTERTITRE]"/>

  <!--[ Date de la publication électronique ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="datepubli" VALUE="[#DATEPUBLI]"/>

  <!--[ Date de la publication papier ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="datepublipapier" VALUE="[#DATEPUBLIPAPIER]"/>

  <!-- [ Barrière mobile ] -->
  <IF COND="[#TYPE] EQ 'article' AND [#DATEPUBLI] GT today()">
    <LET VAR="BM">1</LET>
  </IF>
  <FUNC NAME="CKL_FIELD_BOOL" FIELD="bm" VALUE="[#BM]"/>

  <!--[ Pagination ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="pagination" VALUE="[#PAGINATION]"/>

  <!--[ Langue ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="langue" VALUE="[#LANGUE]"/>

  <!--[ Notice bibliographique de l’œuvre commentée ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="noticebibliooeuvre" VALUE="[#NOTICEBIBLIOOEUVRE]"/>

  <!--[ Titre de l’œuvre commentée ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="titreoeuvre" VALUE="[#TITREOEUVRE]"/>

  <!--[ Date de publication de l’œuvre commentée ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="datepublicationoeuvre" VALUE="[#DATEPUBLICATIONOEUVRE]"/>

  <!--[ Auteur de l’œuvre commentée ]-->
  <FUNC NAME="CKL_PERSONNES" TYPE="auteuroeuvre"/>

 <!--[ Alias de traduction ]-->
 <MACRO NAME="CKL_A_TRADUCTIONS"/>

 <!-- [ Vignettisation simple ] -->
 <FUNC NAME="CKL_FIELD_BOOL" FIELD="vignettesimple" VALUE="[#VIGNETTESIMPLE]"/>

 <!--[ TODO: datemisenligne, dateacceslibre ]-->

  <!--[ Auteurs ]-->
  <FUNC NAME="CKL_A_DESCRIPTION_PERSONNES" TYPE="auteur" IDDOC="[#ID]"/>

  <!--[ Traducteurs ]-->
  <FUNC NAME="CKL_A_DESCRIPTION_PERSONNES" TYPE="traducteur" IDDOC="[#ID]"/>

  <!--[ Editeurs scientifiques ]-->
  <FUNC NAME="CKL_A_DESCRIPTION_PERSONNES" TYPE="editeurscientifique" IDDOC="[#ID]"/>

  <!-- [ Résumés ] -->
  <FUNC NAME="CKL_FIELD_ML" FIELD="resume" VALUE="[#RESUME]"/>

  <!-- [ Entrées d'index ] -->
  <MACRO NAME="CKL_A_ENTRIES"/>

  <!--[ NDLR ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="ndlr" VALUE="[#NDLR]"/>

  <!--[ NDLA ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="ndla" VALUE="[#NDLA]"/>

  <!--[ Errata ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="addendum" VALUE="[#ADDENDUM]"/>

  <!--[ Dédicace ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="dedicace" VALUE="[#DEDICACE]"/>

  <!--[ Remerciements ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="remerciements" VALUE="[#REMERCIEMENTS]"/>

  <!--[ Image d'accroche ]-->
  <FUNC NAME="CKL_ACCROCHE" ID="[#ID]"/>

  <!-- [ Sommaire de l'article ] -->
  <MACRO NAME="CKL_A_TOC"/>

  <!--[ Texte intégral ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="texte" VALUE="[#TEXTE|cleanCallNotes|tocable|tocss('heading')|illustrations(800)|media]"/>

  <!--[ Bibliographie ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="bibliographie" VALUE="[(#BIBLIOGRAPHIE|cleanCallNotes|tocss('heading')|illustrations(800, 'bibliographie')|media)]"/>

  <!--[ Annexes (texte) ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="annexe" VALUE="[#ANNEXE|cleanCallNotes|tocss('heading')|illustrations(800, 'annexe')|media]"/>

  <!--[ Fichiers placés en annexe ]-->
  <MACRO NAME="CKL_A_DOCANNEXES"/>

  <!--[ Notes de bas de page ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="notesbaspage" VALUE="[#NOTESBASPAGE]"/>

  <!--[ Notes de fin ]-->
  <FUNC NAME="CKL_FIELD_STRING" FIELD="notefin" VALUE="[#NOTEFIN]"/>

  <!--[ Fichier facsimilé ]-->
  <MACRO NAME="CKL_A_FACSIMILE"/>
</DEFMACRO>

/**
 * Entrées d'index.
 */
<DEFMACRO NAME="CKL_A_ENTRIES">
  <LOOP NAME="ckl_a_entries_types" TABLE="relations, entries, entrytypes" SELECT="DISTINCT(idtype), title, altertitle, type AS entrytype" WHERE="id1 = '[#ID]' AND id2 = entries.id AND entries.idtype = entrytypes.id AND entrytypes.class = 'indexes'" ORDER="entrytypes.rank">
    <BEFORE>
      <div class="ckl-entries">
    </BEFORE>
    <DO>
      <LOOP NAME="ckl_a_entries" TABLE="entries" SELECT="id, g_name" WHERE="idtype = '[#IDTYPE]' AND iddocument = '[#ID]'" ORDER="degree">
        <BEFORE>
          <div class="ckl-entrytype doc-entrytype-[#ENTRYTYPE]">
        </BEFORE>
        <DO><IF COND="[#COUNT] GE 2">, </IF><a href="[#ID|makeurlwithid]" class="ckl-entry">[#G_NAME]</a></DO>
        <AFTER>
          </div>
        </AFTER>
      </LOOP>
    </DO>
    <AFTER>
      </div>
    </AFTER>
  </LOOP>
</DEFMACRO>

/**
 * Table des matières de l'article.
 */
<DEFMACRO NAME="CKL_A_TOC">
  <IF COND="[#TEXTE]">
    <LET VAR="TOC_PREV_NIVEAU" GLOBAL="1">1</LET>
    <LET VAR="OUVRIR_UL"><li><ul></LET>
    <LET VAR="FERMER_UL"></ul></li></LET>
    <LOOP NAME="toc" TEXT="[#TEXTE]">
      <BEFORE>
        <div class="ckl-toc">
          <ul>
      </BEFORE>
      <DO>
        <LET VAR="ECART">[#NIVEAU|lmath('-', [%TOC_PREV_NIVEAU])]</LET>
        <LET VAR="LIEN"><a href="#tocto[#TOCID]" id="tocfrom[#TOCID]">[#TITRE|removenotes]</a></LET>
          <IF COND="[#ECART] EQ 0">
            <li dir="[#DIR]">[#LIEN]</li>
          <ELSEIF COND="[#ECART] GT 0"/>
            [#OUVRIR_UL|str_repeat([#ECART])]
            <li dir="[#DIR]">[#LIEN]</li>
          <ELSE/>
            [#FERMER_UL|str_repeat([#ECART])]
            <li dir="[#DIR]">[#LIEN]</li>
          </IF>
          <LET VAR="TOC_PREV_NIVEAU" GLOBAL="1">[#NIVEAU]</LET>
        </DO>
        <AFTER>
              <!--[ Fermeture des derniers ul/li ]-->
              <IF COND="[%TOC_PREV_NIVEAU] GT 1">
                [#FERMER_UL|str_repeat([%TOC_PREV_NIVEAU|lmath('-', 1)])]
              </IF>
            </ul>
          </div>
        </AFTER>
    </LOOP>
  </IF>
</DEFMACRO>

/**
 * Fac-similé.
 */
<DEFMACRO NAME="CKL_A_FACSIMILE">
  <IF COND="[#ALTERFICHIER]">
    <div class="ckl-facsimile">
      <a class="ckl-facsimile-a" href="[#ID|makeurlwithid]?file=1">Facsimile ([#ALTERFICHIER|getFileMime]&#160;&#8211; [#ALTERFICHIER|nicefilesize])</a>
    </div>
  </IF>
</DEFMACRO>

/**
 * Fichiers placés en annexe.
 */
<DEFMACRO NAME="CKL_A_DOCANNEXES">
  <IF COND="![#IDPUBLI]"><LET VAR="idpubli">[#ID]</LET></IF>

  <LOOP NAME="ckl_docannexes" SELECT="id" TABLE="entities" WHERE="idparent = '[#IDPUBLI]' AND type LIKE '%annexe'" ORDER="rank">
    <BEFORE>
      <div class="ckl-docannexes">
        <ul>
    </BEFORE>
    <DO>
      <li class="ckl-docannexe" data-class="[#CLASS]" data-id="[#ID]">
        <LOOP NAME="docannexe" TABLE="#_TP_[#CLASS]" WHERE="identity = '[#ID]'">
          <IF COND="[#TYPE] EQ 'lienannexe' AND [#URL]">
            <LET VAR="href">[#URL|htmlspecialchars(ENT_COMPAT, 'UTF-8')]</LET>
          <ELSEIF COND="[#DOCUMENT]"/>
            <LET VAR="href">[#ID|makeurlwithfile]</LET>
          </IF>
          <p class="ckl-docannexe-title">
            <!--[ Lien ]-->
            <IF COND="[#TYPE] EQ 'lienannexe' AND [#URL]">
              <a href="[#HREF]">[#TITRE]</a>
            <!--[ Fichier ]-->
            <ELSEIF COND="[#DOCUMENT]" />
              <a href="[#HREF]">[#TITRE]</a> <span class="ckl-info">([#DOCUMENT|getFileMime]&#160;&#8211; [#DOCUMENT|nicefilesize])</span>
            <ELSEIF COND="[#URLACCESMEDIA]" />
              <a href="[#URLACCESMEDIA]">[#TITRE]</a> <span class="ckl-info">([#URLACCESMEDIA])</span>
            <ELSEIF COND="[#URLMEDIA]" />
              <a href="[#URLMEDIA]">[#TITRE]</a> <span class="ckl-info">([#URLMEDIA])</span>
            <ELSE />
              [#TITRE]
            </IF>
          </p>
          <IF COND="[#CLASS] EQ 'liens' AND [#TEXTE]">
            <p class="ckl-docannexe-description">[#TEXTE]</p>
          <ELSEIF COND="[#CLASS] EQ 'fichiers'"/>
            <IF COND="[#DESCRIPTION]"><div class="ckl-docannexe-description">[#DESCRIPTION]</div></IF>
            <IF COND="[#LEGENDE]"><div class="ckl-docannexe-legende">[#LEGENDE]</div></IF>
            <IF COND="[#CREDITS]"><div class="ckl-docannexe-credits">[#CREDITS]</div></IF>
          </IF>
        </LOOP>
      </li>
    </DO>
    <AFTER>
        </ul>
      </div>
    </AFTER>
  </LOOP>
</DEFMACRO>

/**
 * Description des auteurs, traducteurs...
 * @param {string} type - Type de personne.
 * @param {string} type - ID du document auquel est liée la description.
 */
<DEFFUNC NAME="CKL_A_DESCRIPTION_PERSONNES" REQUIRED="type, iddoc">
  <LOOP NAME="ckl_a_description_personnes" SELECT="persons.id" TABLE="relations, persons" WHERE="id1 = '[#IDDOC]' AND id2 = persons.id AND nature = 'G' AND type = '[#TYPE]'" ORDER="degree">
    <BEFORE>
      <div class="ckl-description-personnes" data-type="[#TYPE]">
    </BEFORE>
    <DO>
      <LOOP NAME="ckl_a_description_personnes_item" TABLE="auteurs" WHERE="id = '[#ID]' AND iddocument='[#IDDOC]'">
        <div class="ckl-personne" data-type="[#TYPE]" data-id="[#ID]">
          <span class="ckl-personne-firstname">[#G_FIRSTNAME]</span>
          <span class="ckl-personne-familyname">[#G_FAMILYNAME]</span>
          <IF COND="[#DESCRIPTION]">
            <p class="ckl-personne-description">[#DESCRIPTION|removetags("p")]</p>
          </IF>
        </div>
      </LOOP>
    </DO>
    <AFTER>
      </div>
    </AFTER>
  </LOOP>
</DEFFUNC>

/**
 * Affichage des alias de traduction du document.
 */
<DEFMACRO NAME="CKL_A_TRADUCTIONS">
  <LOOP NAME="ckl_a_traductions"
        SELECT="id, titre, langue, IF(id IN (SELECT id2 FROM relations WHERE nature = 'traduction'), 1, 0) AS original"
        TABLE="textes, relations"
        WHERE="(id2 = [#ID] AND id1 = textes.identity)
        OR (id1 = [#ID] AND id2 = textes.identity)
        OR (id2 = (SELECT id2 FROM relations WHERE id1 = [#ID] AND nature = 'traduction' LIMIT 1)) AND id1 != [#ID] AND id1 = textes.identity"
        WHERE="nature = 'traduction'"
        ORDER="original DESC">
    <BEFORE>
      <div class="ckl-traductions">
    </BEFORE>
    <DO>
      <LET VAR="original_classname"><IF COND="[#ORIGINAL]"> ckl-traduction-original</IF></LET>
      <p class="ckl-traduction[#ORIGINAL_CLASSNAME]" lang="[#LANGUE]">
        <a href="[#ID|makeurlwithid]">[#TITRE]</a>
      </p>
    </DO>
    <AFTER>
      </div>
    </AFTER>
  </LOOP>
</DEFMACRO>
