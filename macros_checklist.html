<CONTENT VERSION="1.0" LANG="fr" CHARSET="utf-8"/>

/**
 * Checklist main.
 */
<DEFMACRO NAME="CKL_MAIN">
  <USE MACROFILE="macros_checklist_article.html"/>
  <USE MACROFILE="macros_checklist_index.html"/>
  <USE MACROFILE="macros_checklist_publication.html"/>

  <MACRO NAME="CKL_HTML_START"/>

  <LOOP NAME="ckl_main"
        TABLE="entities, types"
        SELECT="id, class, type"
        WHERE="id = '[#DOCUMENT]' AND class IN ('publications', 'textes') AND entities.idtype = types.id">
      <DO>
        <IF COND="[#CLASS] EQ 'textes'">
          <MACRO NAME="CKL_A_MAIN"/>
        <ELSE/>
          <MACRO NAME="CKL_P_MAIN"/>
        </IF>
      </DO>
      <ALTERNATIVE>

        <!--[ Indexes ]-->
        <LOOP NAME="ckl_main_indexes" TABLE="entrytypes" WHERE="id = '[#DOCUMENT]'" >
          <DO>
            <MACRO NAME="CKL_I_MAIN_INDEXES"/>
          </DO>
          <ALTERNATIVE>

            <!--[ Personnes ]-->
            <LOOP NAME="ckl_main_persons" TABLE="persontypes" WHERE="id = '[#DOCUMENT]'" >
              <DO>
                <MACRO NAME="CKL_I_MAIN_PERSONS"/>
              </DO>

              <!--[ Erreur ]-->
              <ALTERNATIVE>
                <p>Document not found.</p>
              </ALTERNATIVE>
            </LOOP>
          </ALTERNATIVE>
        </LOOP>
      </ALTERNATIVE>
  </LOOP>

  <MACRO NAME="CKL_HTML_END"/>
</DEFMACRO>

/**
 * Ouverture de la page HTML.
 */
<DEFMACRO NAME="CKL_HTML_START">
  <!DOCTYPE html>
  <html lang="fr">
  <head>
    <meta charset="utf-8">
    <title>OpenEdition Checklist</title>
    <link rel="stylesheet" href="tpl/css/checklist.css">
  </head>
  <body>
</DEFMACRO>

/**
 * Fermeture de la page HTML.
 */
<DEFMACRO NAME="CKL_HTML_END">
  <MACRO NAME="CKL_HTML_SCRIPTS"/>
  </body>
  </html>
</DEFMACRO>

/**
 * Scripts JavaScript.
 */
<DEFMACRO NAME="CKL_HTML_SCRIPTS">
  <!--[ JQuery ]-->
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

  <!--[ Checklist Core ]-->
  <script src="./tpl/vendor/checklist.js"></script>

  <!--[ Checklist Config ]-->
  <script src="./tpl/js/checklist-config.js"></script>
</DEFMACRO>

/**
 * Affiche une <section> (n'affiche rien si [#CONTENTS] est vide).
 * @param {string} contents - Contenu HTML de la section.
 * @param {string} [title] - Titre de la section.
 * @param {string} [classname] - Attribut class supplémentaire de l'élément section.
 */
<DEFFUNC NAME="CKL_SECTION" REQUIRED="contents" OPTIONAL="title, classname">
  <IF COND="[#CONTENTS|trim] NE ''">
    <section class="ckl-section [#CLASSNAME]">
      <IF COND="[#TITLE]">
        <h2 class="ckl-section-title">[#TITLE]</h2>
      </IF>
      [#CONTENTS]
    </section>
  </IF>
</DEFFUNC>

/**
 * Récupérer le titre d'un champ.
 * TODO: inclure les traductions.
 * @param {string} field - Nom du champ.
 * @param {string} [classname] - Classe (surcharge le [#CLASS] du contexte).
 */
<DEFFUNC NAME="CKL_GET_FIELD_TITLE" REQUIRED="field" OPTIONAL="classname">
  <IF COND="![#CLASSNAME]">
    <LET VAR="classname">[#CLASS]</LET>
  </IF>
  <LOOP NAME="ckl_get_field"
        TABLE="tablefields"
        SELECT="name, title, class"
        WHERE="class='[#CLASSNAME]' AND name = '[#FIELD]'"
        LIMIT="0,1">
    <DO>
      [#TITLE]
    </DO>
    <ALTERNATIVE>
      [#FIELD]
    </ALTERNATIVE>
  </LOOP>
</DEFFUNC>

/**
 * Affichage simple d'un champ texte.
 * @param {string} field - Nom du champ (détermine le classname).
 * @param {string} value - Valeur à afficher.
 * @param {boolean} [classname] - Classname supplémentaire.
 * @param {boolean} [force] - Forcer l'affichage, même si [#VALUE] est vide.
 */
<DEFFUNC NAME="CKL_FIELD_STRING" REQUIRED="field, value" OPTIONAL="classname, force">
  <IF COND="[#FIELD] AND ([#VALUE] OR [#FORCE])">
    <div class="ckl-field ckl-field-string [#CLASSNAME]" data-field="[#FIELD]">
      <div class="ckl-field-title"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="[#FIELD]"/></div>
      <div class="ckl-field-value">[#VALUE]</div>
    </div>
  </IF>
</DEFFUNC>

/**
 * Affichage simple d'un champ bool.
 * @param {string} field - Nom du champ (détermine le classname).
 * @param {string} value - Valeur (0/1). Une case à cocher est affichée si les paramètre oui/non sont vides.
 * @param {string} [oui] - Valeur affichée si oui.
 * @param {string} [non] - Valeur affichée si non.
 */
<DEFFUNC NAME="CKL_FIELD_BOOL" REQUIRED="field, value">
  <IF COND="[#VALUE] NE ''">
    <IF COND="[#VALUE] EQ '1'">
      <LET VAR="res">&#x2611;</LET>
      <IF COND="[#OUI]">
        <LET VAR="res">[#OUI]</LET>
      </IF>
    <ELSE/>
      <LET VAR="res">&#x2610;</LET>
      <LET VAR="value">0</LET>
      <IF COND="[#NON]">
        <LET VAR="res">[#NON]</LET>
      </IF>
    </IF>
    <div class="ckl-field ckl-field-bool" data-field="[#FIELD]" data-value="[#VALUE]">
      <div class="ckl-field-title"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="[#FIELD]"/></div>
      <div class="ckl-field-value">[#RES]</div>
    </div>
  </IF>
</DEFFUNC>

/**
 * Affichage des champs multilingues.
 * @param {string} field - Nom du champ (détermine le classname).
 * @param {string} value - Valeur du champ ml.
 */
<DEFFUNC NAME="CKL_FIELD_ML" REQUIRED="field, value">
  <IF COND="[#VALUE]">
    <div class="ckl-field ckl-field-ml" data-field="[#FIELD]">
      <div class="ckl-field-title"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="[#FIELD]"/></div>
      <div class="ckl-field-value">
        <!--[ La loop "mltext" utilise [#VALUE] du contexte ]-->
        <LOOP NAME="mltext">
          <FUNC NAME="CKL_FIELD_ML_ITEM" LANG="[#LANG]" VALUE="[#VALUE]"/>
        </LOOP>
      </div>
    </div>
  </IF>
</DEFFUNC>

/**
 * Affichage simple d'un champ texte dans une liste multilingue.
 * @param {string} lang - Langue de l'item.
 * @param {string} value - Valeur à afficher.
 * @param {boolean} [force] - Forcer l'affichage, même si [#VALUE] est vide.
 */
<DEFFUNC NAME="CKL_FIELD_ML_ITEM" REQUIRED="lang, value" OPTIONAL="force">
  <IF COND="[#LANG] AND ([#VALUE] OR [#FORCE])">
    <div class="ckl-field ckl-field-ml-item" data-lang="[#LANG]">
      <span class="ckl-field-ml-lang">[#LANG]</span>
      <span class="ckl-field-ml-value">[#VALUE]</span>
    </div>
  </IF>
</DEFFUNC>

/**
 * Affiche les personnes liées à l'entité en cours.
 * @param {string} type - Nom du type des personnes.
 */
<DEFFUNC NAME="CKL_PERSONNES" REQUIRED="type">
  <LOOP NAME="ckl_personnes" SELECT="g_firstname, g_familyname" TABLE="relations, persons" WHERE="id1 = '[#ID]' AND id2 = persons.id AND nature = 'G' AND type = '[#TYPE]'" ORDER="degree">
    <BEFORE>
      <div class="ckl-field ckl-personnes" data-type="[#TYPE]">
        <div class="ckl-field-title"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="[#TYPE]"/></div>
        <div class="ckl-field-value">
    </BEFORE>
    <DO>
      <IF COND="[#COUNT] GE 2">
        <IF COND="[#COUNT] LT [#NBRESULTS]">, <ELSE/> et </IF>
      </IF>
      <span class="ckl-personne" data-type="[#TYPE]" data-id="[#ID]">
        <LET VAR="label_prenom"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="prenom" CLASSNAME="auteurs"/></LET>
        <LET VAR="label_nom"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="nomfamille" CLASSNAME="auteurs"/></LET>
        <span class="ckl-personne-firstname" data-label="[#LABEL_PRENOM|trim]">[#G_FIRSTNAME]</span>
        <span class="ckl-personne-familyname" data-label="[#LABEL_NOM|trim]">[#G_FAMILYNAME]</span>
      </span>
    </DO>
    <AFTER>
        </div>
      </div>
    </AFTER>
  </LOOP>
</DEFFUNC>

/**
 * Entrées d'index.
 * @param {string} classname - Nom de la classe de l'index.
 */
<DEFFUNC NAME="CKL_ENTRIES" REQUIRED="classname">
  <LOOP NAME="ckl_a_entries_types" TABLE="relations, entries, entrytypes" SELECT="DISTINCT(idtype), title, altertitle, type AS entrytype" WHERE="id1 = '[#ID]' AND id2 = entries.id AND entries.idtype = entrytypes.id AND entrytypes.class = '[#CLASSNAME]'" ORDER="entrytypes.rank">
    <BEFORE>
      <div class="ckl-entries">
    </BEFORE>
    <DO>
      <LOOP NAME="ckl_a_entries" TABLE="entries" SELECT="id, g_name" WHERE="idtype = '[#IDTYPE]' AND iddocument = '[#ID]'" ORDER="degree">
        <BEFORE>
          <div class="ckl-field ckl-entrytype doc-entrytype-[#ENTRYTYPE]">
            <div class="ckl-field-title">[#TITLE]</div>
            <div class="ckl-field-value">
        </BEFORE>
        <DO><IF COND="[#COUNT] GE 2">, </IF><a href="[#ID|makeurlwithid]" class="ckl-entry">[#G_NAME]</a></DO>
        <AFTER>
            </div>
          </div>
        </AFTER>
      </LOOP>
    </DO>
    <AFTER>
      </div>
    </AFTER>
  </LOOP>
</DEFFUNC>

/**
 * Affichage des alias de traduction du document.
 */
<DEFMACRO NAME="CKL_TRADUCTIONS">
  <LOOP NAME="ckl_traductions"
        SELECT="id, titre, langue, IF(id IN (SELECT id2 FROM relations WHERE nature = 'traduction'), 1, 0) AS original"
        TABLE="textes, relations"
        WHERE="((id2 = [#ID] AND id1 = textes.identity)
        OR (id1 = [#ID] AND id2 = textes.identity)
        OR (id2 = (SELECT id2 FROM relations WHERE id1 = [#ID] AND nature = 'traduction' LIMIT 1)) AND id1 != [#ID] AND id1 = textes.identity)
        AND (nature = 'traduction')"
        ORDER="original DESC">
    <BEFORE>
      <div class="ckl-field ckl-traductions">
        <div class="ckl-field-title"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="traduction"/></div>
        <div class="ckl-field-value">
          <ul>
    </BEFORE>
    <DO>
      <li class="ckl-traduction" lang="[#LANGUE]">
        <span class="ckl-field-ml-lang">[#LANGUE]</span>
        <span class="ckl-field-ml-value"><a href="[#ID|makeurlwithid]">[#TITRE]</a></span>
        <span class="ckl-field-ml-id">([#ID])</span>
        <IF COND="[#ORIGINAL]">
          <span class="ckl-traduction-original">[original]</span>
        </IF>
      </li>
    </DO>
    <AFTER>
          </ul>
        </div>
      </div>
    </AFTER>
  </LOOP>
</DEFMACRO>

/**
 * Retourne 1 si le document est lié à un document source.
 */
<DEFMACRO NAME="CKL_IS_TRADUCTION">
  <LOOP NAME="ckl_is_traduction"
        SELECT="id"
        TABLE="textes, relations"
        WHERE="(id1 = [#ID] AND id2 = textes.identity) AND (nature = 'traduction')"
        LIMIT="0,1">
    <DO>1</DO>
  </LOOP>
</DEFMACRO>

/**
 * Fichiers.
 */
<DEFMACRO NAME="CKL_FICHIERS">
  <LOOP NAME="ckl_fichiers"
        TABLE="fichiers"
        WHERE="idparent = [#ID]"
        SELECT="id, titre, type, document"
        ORDER="rank">
    <BEFORE>
      <div class="ckl-field ckl-fichiers">
        <div class="ckl-field-title">Fichiers</div>
        <div class="ckl-field-value">
    </BEFORE>
    <DO>
      <div class="ckl-fichier">
        <LET VAR="label_titre"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="titre"/></LET>
        <p class="ckl-fichier-titre" data-label="[#LABEL_TITRE|trim]"><IF COND="[#TITRE]">[#TITRE]<ELSE/>-</IF></p>
        <!--[ TODO: Label dynamique ]-->
        <p class="ckl-fichier-type" data-label="Type">[#TYPE]</p>
        <IF COND="[#DOCUMENT]">
          <LET VAR="label_document"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="document"/></LET>
          <p class="ckl-fichier-document" data-label="[#LABEL_DOCUMENT|trim]"><a href="[#DOCUMENT]">[#DOCUMENT]</a></p>
        </IF>
      </div>
    </DO>
    <AFTER>
        </div>
      </div>
    </AFTER>
  </LOOP>
</DEFMACRO>

/**
 * Fichiers externes.
 */
<DEFMACRO NAME="CKL_FICHIERSEXTERNES">
  <LOOP NAME="ckl_fichiersexternes"
        TABLE="fichiersexternes"
        WHERE="idparent = [#ID]"
        SELECT="id, titre, type, urlmedia"
        ORDER="rank">
    <BEFORE>
      <div class="ckl-field ckl-fichiersexternes">
        <div class="ckl-field-title">Fichiers externes</div>
        <div class="ckl-field-value">
    </BEFORE>
    <DO>
      <div class="ckl-fichierexterne">
        <LET VAR="label_titre"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="titre"/></LET>
        <p class="ckl-fichierexterne-titre" data-label="[#LABEL_TITRE|trim]"><IF COND="[#TITRE]">[#TITRE]<ELSE/>-</IF></p>
        <!--[ TODO: Label dynamique ]-->
        <p class="ckl-fichierexterne-type" data-label="Type">[#TYPE]</p>
        <IF COND="[#URLMEDIA]">
          <LET VAR="label_urlmedia"><FUNC NAME="CKL_GET_FIELD_TITLE" FIELD="urlmedia"/></LET>
          <p class="ckl-fichierexterne-urlmedia" data-label="[#LABEL_URLMEDIA]"><a href="[#URLMEDIA]">[#URLMEDIA]</a></p>
        </IF>
      </div>
    </DO>
    <AFTER>
        </div>
      </div>
    </AFTER>
  </LOOP>
</DEFMACRO>
