<CONTENT VERSION="1.0" LANG="fr" CHARSET="utf-8"/>

/**
 * Main home.
 */
<DEFMACRO NAME="CKL_H_MAIN">
	<LET VAR="checklist_context" GLOBAL="1">{ home: true }</LET>

	<div class="ckl-main ckl-home">
		<div id="ckl-pane" class="ckl-pane"></div>
		<div class="ckl-content">
			<MACRO NAME="CKL_H_CONTENT"/>
		</div>
	</div>
</DEFMACRO>

/**
 * Contenu home.
 */
<DEFMACRO NAME="CKL_H_CONTENT">
	<h1 class="main-title">[#OPTIONS.METADONNEESSITE.TITRESITE]</h1>
	<MACRO NAME="CKL_H_TABS" />
	<MACRO NAME="CKL_H_TABCONTENTS" />
</DEFMACRO>

/**
 * Onglets de la home.
 */
<DEFMACRO NAME="CKL_H_TABS">
	<nav class="ckl-tabs">
		<IF COND="![#VIEW_TAB]">
			<LET VAR="activate_first">1</LET>
		</IF>
		<FUNC NAME="CKL_H_TAB" TITLE="[#CKL_TRANSLATIONS.ISSUES]" TARGET="issues" ACTIVE="[#ACTIVATE_FIRST]" />

		<LET VAR="indexes_title"><FUNC NAME="CKL_GET_CLASS_TITLE" CLASS="indexes" /></LET>
		<FUNC NAME="CKL_H_TAB" TITLE="[#INDEXES_TITLE]" TARGET="indexes" />
	</nav>
</DEFMACRO>

/**
 * Onglet.
 * @param {string} title - Titre de l'onglet.
 * @param {string} target - Target id.
 * @param {string} active - Force la class "active".
 */
<DEFFUNC NAME="CKL_H_TAB" REQUIRED="title, target" OPTIONAL="active">
	<IF COND="[#VIEW_TAB] EQ [#TARGET]">
		<LET VAR="active_class">active</LET>
	</IF>
	<LET VAR="href"><FUNC NAME="CKL_URL" DOCUMENT="0" PARAMETER="view_tab=[#TARGET]" /></LET>
	<a class="ckl-tab [#ACTIVE_CLASS]" href="[#HREF]">[#TITLE]</a>
</DEFFUNC>

/**
 * Contenus des onglets.
 */
<DEFMACRO NAME="CKL_H_TABCONTENTS">
	<IF COND="[#VIEW_TAB] EQ 'indexes'">
		<MACRO NAME="CKL_H_INDEXES" />
	<ELSE />
		<MACRO NAME="CKL_H_ISSUES" />
	</IF>
</DEFMACRO>

/**
 * Tous les index.
 */
<DEFMACRO NAME="CKL_H_INDEXES">
	<!--[ Mots-clés ]-->
	<LET VAR="tableindex">#_TP_entries</LET>
	<LET VAR="tabletypes">#_TP_entrytypes</LET>
	<LET VAR="tablefilter">AND class = 'indexes'</LET>

	<LOOP NAME="ckl_h_indexes" TABLE="[#TABLEINDEX], [#TABLETYPES]" SELECT="DISTINCT(idtype), title, altertitle" WHERE="[#TABLEINDEX].idtype = [#TABLETYPES].id AND [#TABLEINDEX].status GT 0 [#TABLEFILTER]" ORDER="CASE WHEN type LIKE 'motscles%' THEN 0 ELSE 1 END, [#TABLETYPES].rank">
		<BEFORE>
			<ul class="ckl-indexes">
		</BEFORE>
		<DO>
			<li class="ckl-index">
				<LET VAR="href"><FUNC NAME="CKL_URL" DOCUMENT="[#IDTYPE]" /></LET>
				<a href="[#HREF]"><IF COND="[#ALTERTITLE:#SITELANG]">[#ALTERTITLE:#SITELANG]<ELSE/>[#TITLE]</IF></a>
			</li>
		</DO>
		<AFTER>
			</ul>
		</AFTER>
	</LOOP>

	<!--[ Auteurs ]-->
	<LET VAR="tableindex">#_TP_persons</LET>
	<LET VAR="tabletypes">#_TP_persontypes</LET>
	<LET VAR="tablefilter"></LET>
	<LOOP NAME="ckl_h_indexes"></LOOP>
</DEFMACRO>

/**
 * Tous les numéros.
 */
<DEFMACRO NAME="CKL_H_ISSUES">
	<LET VAR="NUMEROS_PAR_PAGE">10</LET>
	<LOOP NAME="ckl_h_numeros" TABLE="publications" WHERE="type = 'numero' AND paraitre != 1" ORDER="rank DESC" SPLIT="[#NUMEROS_PAR_PAGE]">
		<BEFORE>
			<div class="ckl-issues">
		</BEFORE>
		<DO>
			<MACRO NAME="CKL_H_ISSUE" />
		</DO>
		<AFTER>
			<!--[ Flexbox workaround ]-->
			<div class="ckl-issue-placeholder"></div>
			</div>
			<IF COND="[#NBRESULTS] GT [#NUMEROS_PAR_PAGE]">
				<MACRO NAME="CKL_PAGE_SCALE" />
			</IF>
		</AFTER>
	</LOOP>
</DEFMACRO>

/**
 * Afficher un numéro.
 */
<DEFMACRO NAME="CKL_H_ISSUE">
	<LET VAR="href"><FUNC NAME="CKL_URL" DOCUMENT="[#IDTYPE]" /></LET>
	<div class="ckl-issue">
		<!--[ Titre et numéro ]-->
		<h2 class="ckl-issue-title"><a href="[#HREF]"><IF COND="[#NUMERO]"><span class="ckl-issue-number">[#NUMERO] | </span></IF>[#TITRE|removenotes|replacequotationmark|reg_replace("/(\r\n|\r|\n)+/", " ")]</a></h2>

		<div class="ckl-issue-row">
			<!--[ Progression Checklist ]-->
			<div class="ckl-issue-stackedbar-container" data-children-ids='<MACRO NAME="CKL_H_ISSUE_CONTENTS" />'></div>

			<!--[ Bouton "Vérifier" ]-->
			<a href="[#HREF]" class="ckl-issue-link"><i class="far fa-play-circle"></i> [#CKL_TRANSLATIONS.CHECK]</a>
		</div>
	</div>
</DEFMACRO>

/**
 * Récupérer les identifiants d'une publication (récursif).
 */
<DEFMACRO NAME="CKL_H_ISSUE_CONTENTS">
	[#ID]
	<LOOP NAME="ckl_h_issue_contents"
		TABLE="entities, types"
		SELECT="id, class, type"
		WHERE="idparent = '[#ID]'
			AND type NOT IN ('fluxdesyndication','imageaccroche','rubriqueannuelle', 'imageaccrochelibrairie') AND type NOT LIKE '%annexe%'
			AND entities.idtype = types.id"
		ORDER="entities.rank">

		<LOOP NAME="ckl_h_issue_contents_item" TABLE="#_TP_[#CLASS]" WHERE="identity = '[#ID]'">
			<SWITCH TEST="[#CLASS]">
				<!--[ Publication : recursion ]-->
				<DO CASE="publications">
					<LOOP NAME="ckl_h_issue_contents"></LOOP>
				</DO>

				<!--[ Textes ]-->
				<DO CASE="textes">
					, [#ID]
				</DO>
			</SWITCH>
		</LOOP>
	</LOOP>
</DEFMACRO>