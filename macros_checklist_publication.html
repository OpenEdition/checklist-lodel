<CONTENT VERSION="1.0" LANG="fr" CHARSET="utf-8"/>

/**
 * Main publication.
 */
<DEFMACRO NAME="CKL_P_MAIN">
  <LOOP NAME="ckl_p_main"
        TABLE="publications"
        WHERE="id=[#DOCUMENT]">
    <MACRO NAME="CKL_CREATE_CONTEXT"/>
    <MACRO NAME="CKL_P_CREATE_PUBLI"/>

    <div class="ckl-main ckl-publication">
      <div class="ckl-content">
        <div class="ckl-toc"></div>
        <MACRO NAME="CKL_P_CONTENT"/>
      </div>
      <div class="ckl-pane"></div>
    </div>
  </LOOP>
</DEFMACRO>

/**
 * Création du paramètre 'publi' passé à Checklist.
 */
<DEFMACRO NAME="CKL_P_CREATE_PUBLI"/>
  <LET VAR="checklist_publi" GLOBAL="1">
    {
      title: "[#TITRE|replace('"', "'")]",
      parent: ".ckl-toc",
      toc: [
        {
          title: "<span class='title'>[#TITRE|replace('"', "'")]</span>",
          href: window.location.href,
          docId: "[#DOCUMENT]",
          type: "Publication",
          icon: "<i class='fas fa-book'></i>",
          context: {"publications": true}
        }

        <LOOP NAME="create_publi_summary"
              TABLE="entities, types"
              SELECT="id, class, type"
              WHERE="idparent = '[#ID]'
                 AND type NOT IN ('fluxdesyndication','imageaccroche','rubriqueannuelle', 'imageaccrochelibrairie') AND type NOT LIKE '%annexe%'
                 AND entities.idtype = types.id"
              ORDER="entities.rank">

          <LOOP NAME="create_publi_summary_item" TABLE="#_TP_[#CLASS]" WHERE="identity = '[#ID]'">
            <SWITCH TEST="[#CLASS]">
              <!--[ Publications ]-->
              <DO CASE="publications">
                <!--[ Sommaire récursif ]-->
                <LOOP NAME="create_publi_summary"></LOOP>
              </DO>

              <!--[ Textes ]-->
              <DO CASE="textes">
                <LET VAR="entry_authors">
                  <FUNC NAME="CKL_PERSONNES_RAW" TYPE="auteur"/>
                </LET>
                <LET VAR="entry_full_title">
                  <span class='authors'>[#ENTRY_AUTHORS|textebrut|trim]</span>
                  <span class='title'>[#TITRE|replace('"', "'")]</span>
                </LET>
                ,{
                  title: "[#ENTRY_FULL_TITLE|trim]",
                  href: "./?page=checklist&document=[#ID]",
                  docId: "[#ID]",
                  context: {
                    "[#CLASS]": true,
                    "[#TYPE]": true
                  }
                }
              </DO>
            </SWITCH>
          </LOOP>
        </LOOP>
      ]
    }
  </LET>
</DEFMACRO>

/**
 * Contenu publication.
 */
<DEFMACRO NAME="CKL_P_CONTENT">
  <!--[ Nav entities ]-->
  <MACRO NAME="CKL_NAV_ENTITIES"/>

  <!--[ Section Titre ]-->
  <LET VAR="section_contents">
    <!--[ Titre du document ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="titre" VALUE="[#TITRE]"/>

    <!--[ Sous-titre du document ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="soustitre" VALUE="[#SOUSTITRE]"/>

    <!--[ Langue ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="langue" VALUE="[#LANGUE]"/>
  </LET>
  <FUNC NAME="CKL_SECTION" CONTENTS="[#SECTION_CONTENTS]" />

  <!--[ Section Cartouche ]-->
  <LET VAR="section_contents">
    <!--[ Date de la publication électronique ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="datepubli" VALUE="[#DATEPUBLI]"/>

    <!--[ Date de la publication papier ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="datepublipapier" VALUE="[#DATEPUBLIPAPIER]"/>

    <!-- [ Cette publication est-elle à paraître ? ] -->
    <FUNC NAME="CKL_FIELD_BOOL" FIELD="paraitre" VALUE="[#PARAITRE]" OUI="Oui" NON="Non"/>

    <!-- [ Numéro ouvert ] -->
    <FUNC NAME="CKL_FIELD_BOOL" FIELD="numeroouvert" VALUE="[#NUMEROOUVERT]" OUI="Oui" NON="Non"/>

    <!--[ Date de mise en ligne ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="datemisenligne" VALUE="[#DATEMISENLIGNE]"/>

    <!--[ Date de mise en accès libre ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="dateacceslibre" VALUE="[#DATEACCESLIBRE]"/>

    <!-- [ Cette publication est-elle en libre accès ? ] -->
    <FUNC NAME="CKL_FIELD_BOOL" FIELD="integralite" VALUE="[#INTEGRALITE]" OUI="Oui" NON="Non"/>
  </LET>
  <FUNC NAME="CKL_SECTION" CONTENTS="[#SECTION_CONTENTS]" CLASSNAME="ckl-cartouche" />

  <!--[ Section avec tout le reste ]-->
  <LET VAR="section_contents">
    <!--[ Titres alternatifs ]-->
    <FUNC NAME="CKL_FIELD_ML" FIELD="altertitre" VALUE="[#ALTERTITRE]"/>

    <!--[ Introduction de la publication ]-->
    <FUNC NAME="CKL_FIELD_ML" FIELD="introduction" VALUE="[#INTRODUCTION]"/>

    <!--[ NDLR ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="ndlr" VALUE="[#NDLR]"/>

    <!--[ Période de publication ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="periode" VALUE="[#PERIODE]"/>

    <!--[ Numéro de publication ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="numero" VALUE="[#NUMERO]"/>

    <!-- [ Licence ] -->
    <FUNC NAME="CKL_ENTRIES" CLASSNAME="indexavances"/>

    <!--[ Directeur de la publication ]-->
    <FUNC NAME="CKL_PERSONNES" TYPE="directeurdelapublication"/>

    <!-- [ Entrées d'index ] -->
    <FUNC NAME="CKL_ENTRIES" CLASSNAME="indexes"/>
  </LET>
  <FUNC NAME="CKL_SECTION" CONTENTS="[#SECTION_CONTENTS]" />

  <!--[ Section Fichiers ]-->
  <LET VAR="section_contents">
    <!--[ Fichiers ]-->
    <MACRO NAME="CKL_FICHIERS"/>

    <!--[ Fichiers externes ]-->
    <MACRO NAME="CKL_FICHIERSEXTERNES"/>
  </LET>
  <FUNC NAME="CKL_SECTION" CONTENTS="[#SECTION_CONTENTS]" />

  <!-- [ Section sommaire de la publication ] -->
  <LET VAR="section_contents">
    <MACRO NAME="CKL_P_SUMMARY"/>
  </LET>
  <FUNC NAME="CKL_SECTION" CONTENTS="[#SECTION_CONTENTS]" CLASSNAME="ckl-summary-section" TITLE="[@SOMMAIRE]"/>
</DEFMACRO>

/**
 * Sommaire récursif de la publication.
 */
<DEFMACRO NAME="CKL_P_SUMMARY">
  <LOOP NAME="summary"
        TABLE="entities, types"
        SELECT="id, class, type"
        WHERE="idparent = '[#ID]'
           AND type NOT IN ('fluxdesyndication','imageaccroche','rubriqueannuelle', 'imageaccrochelibrairie') AND type NOT LIKE '%annexe%'
           AND entities.idtype = types.id"
        ORDER="entities.rank">

    <BEFORE>
      <ul class="ckl-summary">
    </BEFORE>

    <DO>
      <LOOP NAME="summary_item" TABLE="#_TP_[#CLASS]" WHERE="identity = '[#ID]'">
        <SWITCH TEST="[#CLASS]">
          <!--[ Publications ]-->
          <DO CASE="publications">
            <IF COND="[#TYPE] EQ 'rubrique' OR [#TYPE] EQ 'souspartie'">
              <li class="ckl-summary-item ckl-summary-item-[#CLASS]" lang="[#LANGUE]" data-class="[#CLASS]">
                <MACRO NAME="CKL_P_SUMMARY_PUBLI_HEADER"/>
                <!--[ Sommaire récursif ]-->
                <LOOP NAME="summary"></LOOP>
              </li>
            </IF>
          </DO>

          <!--[ Textes ]-->
          <DO CASE="textes">
            <MACRO NAME="CKL_P_SUMMARY_TEXTE"/>
          </DO>
        </SWITCH>
      </LOOP>
    </DO>

    <AFTER>
      </ul>
    </AFTER>
  </LOOP>
</DEFMACRO>

<DEFMACRO NAME="CKL_P_SUMMARY_PUBLI_HEADER">
  <div class="ckl-summary-publi-header">
    <!--[ Titre de la publication ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="titre" VALUE="[#TITRE]"/>

    <!--[ Sous-titre de la publication ]-->
    <FUNC NAME="CKL_FIELD_STRING" FIELD="soustitre" VALUE="[#SOUSTITRE]"/>

    <!--[ Titres alternatifs ]-->
    <FUNC NAME="CKL_FIELD_ML" FIELD="altertitre" VALUE="[#ALTERTITRE]"/>

    <!--[ Directeur de la publication ]-->
    <FUNC NAME="CKL_PERSONNES" TYPE="directeurdelapublication"/>
  </div>
</DEFMACRO>

<DEFMACRO NAME="CKL_P_SUMMARY_TEXTE">
  <LET VAR="is_traduction"><MACRO NAME="CKL_IS_TRADUCTION" ID="[#ID]"/></LET>
  <!--[ On n'affiche que les originaux... ]-->
  <IF COND="![#IS_TRADUCTION|trim]">
    <li class="ckl-summary-item ckl-summary-item-[#CLASS]" lang="[#LANGUE]" data-class="[#CLASS]">
      <FUNC NAME="CKL_PERSONNES" TYPE="auteur"/>
      <div class="ckl-summary-text-title"><a href="./?page=checklist&document=[#ID]">[#TITRE]</a></div>
      <!--[ ...puis ensuite leurs traductions ]-->
      <MACRO NAME="CKL_TRADUCTIONS" />
    </li>
  </IF>
</DEFMACRO>
